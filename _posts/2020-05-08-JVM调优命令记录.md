---
layout: post
title: JVM调优命令
categories: 基础知识
description: JVM调优命令记录。
keywords: Java,Jvm,调优



---

本文记录JVM调优相关命令，方便后续查询。

1、查看进程占用内存情况

```
ps aux | sort -k4,4nr | head -n 10   #查看内存占用前10名的程序

top -p 进程号      # 查看进程cpu和内存使用情况
```

2、查看进程堆使用情况

```
jmap -heap 进程号
参考 https://www.cnblogs.com/shoufeng/p/9739525.html
```

3、参考优化

```
16G内存 JDK8 生产服务器配置未验证，先丢完整配置

JAVA_OPTS="-server -Xmx4g -Xms4g -Xmn256m -Xss256k -XX:+DisableExplicitGC  -XX:+UseConcMarkSweepGC -XX:+CMSParallelRemarkEnabled -XX:LargePageSizeInBytes=128m -XX:+UseFastAccessorMethods -XX:+UseCMSInitiatingOccupancyOnly -XX:CMSInitiatingOccupancyFraction=70 -Duser.timezone=GMT+8"

-server//服务器模式
-Xmx4g //JVM最大允许分配的堆内存，按需分配
-Xms4g //JVM初始分配的堆内存，一般和Xmx配置成一样以避免每次gc后JVM重新分配内存。
-Xmn256m //年轻代内存大小，整个JVM内存=年轻代 + 年老代 + 持久代 
-Xss512k //设置每个线程的堆栈大小
-XX:+DisableExplicitGC //忽略手动调用GC, System.gc()的调用就会变成一个空调用，完全不触发GC
-XX:+UseConcMarkSweepGC //并发标记清除（CMS）收集器
-XX:+CMSParallelRemarkEnabled //降低标记停顿
-XX:LargePageSizeInBytes=128m //内存页的大小
-XX:+UseFastAccessorMethods //原始类型的快速优化
-XX:+UseCMSInitiatingOccupancyOnly //使用手动定义初始化定义开始CMS收集
-XX:CMSInitiatingOccupancyFraction=70 //使用cms作为垃圾回收使用70％后开始CMS收集

-Duser.timezone=GMT+8 //设定GMT区域，避免CentOS坑爹的时区设置

参考http://developer.51cto.com/art/201507/486162.htm

根据运行环境去掉了

-XX:PermSize

-XX:+UseCMSCompactAtFullCollection

Xss512k 在jenkins里面会出现显示系统配置页面不正常的情况，增加到了512k
```

**一、打开文件句柄数过多(too many open files) **

一般报too many open files是因为文件打开数超过了系统设置的最大的打开文件数，出现这类问题，首先可以调整操作系统的最大文件数，如果还不能解决问题，则需要看一下代码是否存在打开没有关闭的情况。

1. 从系统级别处理

   ```
   ulimit -u 查看open files设置 默认好像是1024 linux
   ulimit -a 查看所有设置
   ulimit -u 65535(新的open files 值)修改设置
   ulimit -n 65536 设置用户可以同时打开的最大文件数（max open files） 默认是2048
   如果本参数设置过小，对于并发访问量大的网站，可能会出现too many open files的错误 
   使用lsof -p pid [httpd进程的 pid、java的pid]来查看系统中apache进程和java运行时进程当前打开的文件资源，发现两者之和已
   经接近1024，大于了默认的设置
   
   1、修改配置：（我看机器上好像都有）
   修改/etc/security/limits.conf，在文件末加上
   * soft nofile 65536
   * hard nofile 65536
   
   2、检查 /etc/bashrc文件
   看是否有  ulimit -n 2048 ，有的话注释掉
   3、修改 /etc/profile 文件
   添加
   ulimit -u 65535
   ulimit -SHn 65535
   4、 /etc/pam.d/su /etc/pam.d/sshd /etc/pam.d/login 文件中添加
         session    required     pam_limits.so
   这个也看到过 ，加不加不知道有没有效果
   ```

   

2. 通过lsof分析

```
lsof -p 进程号         # 查看单个进程所有打开的文件详情
lsof -p 进程号 | wc -l   # 统计进程打开了多少文件
lsof -p 进程号 |grep 'sock' -c  #查看对应进程看的sock名称的数量
lsof -p 进程号 > lsof.log  将执行结果内容输出到日志文件中查看(当文件太多的情况),可以将日志下载到本地
cat lsof.log | awk '{print $8}' | sort | uniq -c | sort -rn | head -n 10 #筛选出占用句柄前十的信息
netstat -tnpoa|grep 进程号
strace -p 进程


```

查看lsof.log发现是使用spring restemplate造成的，默认情况下使用SimpleClientHttpRequestFactory，这个是不带连接池的，每次发起一请求，都会创建一个连接，高并发时就会出现too many open files，改成带连接池的HttpComponentsClientHttpRequestFactory就解决了。