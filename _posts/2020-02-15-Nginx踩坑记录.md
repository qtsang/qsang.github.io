---
layout: post
title: Nginx使用踩坑记录
categories: 中间件
description: 记录使用Ngnix中遇到的坑，方便以后回顾，避免问题再次发生。
keywords: 中间件,nginx

---

本文记录工作中使用Nginx代理Tomcat遇到的坑。

一、Nginx代理Tomcat问题(对外使用Nginx提供Https访问，对内Tomcat使用Http)

1、Spring Boot OAuth2 认证失败的问题,发现客户端是Https，跳转到Oauthserver后，获取的是Http问题。

NGINX

```java
   proxy_set_header HOST $host;
   proxy_set_header X-Real-IP $remote_addr;
   proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
   proxy_set_header X-Forwarded-Proto https;
```

Tomcat

```java
<Engine >
    <Valve className="org.apache.catalina.valves.RemoteIpValve"  
    remoteIpHeader="X-Forwarded-For"  
    protocolHeader="X-Forwarded-Proto"  
    protocolHeaderHttpsValue="https"/> 
</Engine >
```

2.使用下划线的KEY存放JWT，导致使用NGINX转发后无法获取。

```java
headers.set("access_token", jwt);
```

在设置HEADER时，KEY使用了下划线，需要开启NGINX支持下划线

```shell
underscores_in_headers on;
```

3、Nginx负载问题

为了解决session共享问题，会使用ip_hash作为负载均衡算法。我们的客户端请求，首先是请求到一个网关服务，由网关服务再转发到Nginx，此时Nginx拿到的ip都是网关服务的，这样的话IP就会转发到一个节点，负责不均衡。可以通过自定义Hash策略来实现。

```
#获取用户真实IP，并赋值给变量$clientRealIP
map $http_x_forwarded_for $clientRealIp {
“” $remote_addr;
~^(?P<firstAddr>[0-9\.]+),?.*$ $firstAddr;
}
#通过自定义策略到相应的节点
upstream h5 {
hash $clientRealIp;
server 192.168.100.104:9080;
server 192.168.100.105:9080;
}
```

